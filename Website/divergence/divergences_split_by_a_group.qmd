# Divergences split by another group
<center>
![](images/divergence_within_divergence.png){style="width:300px; background: white; border-radius:5px"}
</center>

There are times when you may want to analyse divergences of a grouping within a different grouping.

This page will quickly show you how to examine the inter- and intra-divergences of media within the sites.
In other words, we want to examine the media inter-/intra-distances of the intra-site distances.

If you were to perform this with your own data you would preferably have more data points than the amount in this dataset.

## Data

We are starting with the `beta_long_tbl` object created in the [Data format section](/divergence/divergence_data_format.qmd).

```{r eval=FALSE}
beta_long_tbl |> head()
```

## Intra-media by intra-site

The code sections below carries out the intra-media divergences split by site.

### Tibble creation

First we create a new tibble formatted for our analysis.

```{r eval=FALSE}
#Tibble creation
intra_media_intra_site_wunifrac_long_tbl <-
    beta_long_tbl |>
    #Filter to only keep intra-site values
    dplyr::filter(site_L == site_R)
    #Filter to only keep intra-media values
    dplyr::filter(media_L == media_R) |>
    #Filter to remove upper triangle values (i.e. duplicates)
    dplyr::filter(triangle == "lower") |>
intra_media_intra_site_wunifrac_long_tbl |> head()
```

### Violin plot

With our tibble we can create a violin plot.
We'll set the x-axis to our media and the colours to our site grouping.
You could swap these but I normally find it better to have groupings with more categories split by the x-axis rather than by colour (media = 4 categories, site = 3 categories).

```{r eval=FALSE}
#Violin intra-media divergence plot by site
intra_media_by_site_violin_plot <-
    intra_media_intra_site_wunifrac_long_tbl |>
    #Plot
    ggplot2::ggplot(aes(x = media_L, y = value)) +
    ggplot2::geom_violin(aes(colour=site_L)) +
    ggforce::geom_sina(aes(colour=site_L), alpha = 0.5) +
    ggplot2::labs(x = "Media", y = "Weighted UniFrac",
                title = "Intra-media divergence split by site with Weighted UniFrac dissimilarity",
                colour = "Site")
#Save ggplot2 object with ggsave
ggsave(filename = "./wunifrac_intra_media_divergence_split_by_site_violinplot.png",
        plot = intra_media_by_site_violin_plot,
        device = png, dpi = 300, units = "mm", height = 100, width = 170)
#Display plot
IRdisplay::display_png(file = "./wunifrac_intra_media_divergence_split_by_site_violinplot.png")
```

### Stats

Finally we can carry out statistics to determine if the grouping are statistically different with a pairwise Wilcox test.

```{r eval=FALSE}
pairwise.wilcox.test(intra_media_intra_site_wunifrac_long_tbl$value,
                        intra_media_intra_site_wunifrac_long_tbl$site.media_L)
```

### Interpretation

Unfortunately we have few data points (3 per violin) as we are are only using paired distances where the site and media are identical (intra-site and intra-media).
This means low statistical power and has most likely led to all our p-values equalling 1.

In our case the paired points are within a set of replicates and can be thought of as intra-replicate distances (the real world samples were split into three).
More replicates will give more paired distance points; 3 replicates gives 3 pairs, 4 gives 6, 5 gives 10 (`n(n-1)/2`).

In this case we can see:

- The CVP media produces the lowest intra-site distances
- KBC and TSA produce higher ranges of intra-site distances
- The intra-distances for the ENV LD samples are much lower compared to the ENV MD and ENV UD samples.

Although these are intra-replicate distances this might not be the case for your own data. 
If you have groupings based on more than 2 primary groupings (e.g. site, media, and date) you should not discuss these types of findings in terms of replicates.

## Inter-media by intra-site

The code sections below carries out the inter-media divergences split by site.

### Tibble creation

Create our formatted tibble. 
This involves first filtering otu all inter-site values to retain the intra-site values.
Next, we retain only inter-media values.
Note in this case we do not remove the upper triangle values.

```{r eval=FALSE}
#Tibble creation
inter_media_intra_site_wunifrac_long_tbl <-
    intra_site_wunifrac_long_tbl |>
    #Filter to only keep intra-site values
    dplyr::filter(site_L == site_R) |>
    #Filter to only keep inter-media values
    dplyr::filter(media_L != media_R) |>
inter_media_intra_site_wunifrac_long_tbl |> head()
```

### Violin plot

Create the inter-media by intra-site violin plot.

```{r eval=FALSE}
#Inter-media by site
#Violin inter-media divergence plot by site
inter_media_by_site_violin_plot <-
    inter_media_intra_site_wunifrac_long_tbl |>
    #Plot
    ggplot2::ggplot(aes(x = media_L, y = value)) +
    ggplot2::geom_violin(aes(colour=site_L)) +
    ggforce::geom_sina(aes(colour=site_L), alpha = 0.5) +
    ggplot2::labs(x = "Media", y = "Weighted UniFrac",
                title = "Inter-media divergence split by site with Weighted UniFrac dissimilarity",
                colour = "Site")
#Save ggplot2 object with ggsave
ggsave(filename = "./wunifrac_inter_media_divergence_split_by_site_violinplot.png",
        plot = intra_site_wunifrac_long_tbl,
        device = png, dpi = 300, units = "mm", height = 100, width = 170)
#Display plot
IRdisplay::display_png(file = "./wunifrac_inter_media_divergence_split_by_site_violinplot.png")
```

### Stats

Run a pairwise Wilcox test.

```{r eval=FALSE}
pairwise.wilcox.test(inter_media_intra_site_wunifrac_long_tbl$value,
                        inter_media_intra_site_wunifrac_long_tbl$site.media_L)
```

Immediately noticeable is that a warning message about exact p-value with ties shows up.
This can be ignored and you could suppress the message by including the option `exact=FALSE`.

### Interpretation

As we are working with intra-media values we have a lot more values/points and therefore more power.
The main points from our analysis are:

- There are no meaningful differences between the different media based groups (LD_CVP, LD_KBC, LD_TSA, MD_CVP, MD_KBC, etc.). Additionally, their dissimilarity values have very large ranges.
- LD_ENV has the highest dissimilarity values with a low range and are significantly different to al other groupings except LD_KBC
- MD_ENV & UD_ENV are quite similar with generally larger values than the CVP, KBC, and TSA groupings.
    - They are significantly different to the following groupings:
        - MD_ENV to: LD_ENV, MD_CVP, MD_TSA, UD_CVP, UD_KBC, & UD_TSA
        - UD_ENV to: LD_ENV, MD_TSA, UD_CVP, UD-KBC, & UD_TSA

