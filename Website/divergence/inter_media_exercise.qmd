# Inter-media exercise
<center>
![](images/petri_inter.png){style="width:200px; background: white; border-radius:5px"}
</center>

Now to carry out inter-media divergence analysis.

For this exercise you will create your own code.
Solutions are available in the solution boxes below but please make a strong attempt before looking at them.

I would recommend copying, pasting, and editing your code from the inter-site analysis. 
Ensure you change all the variable names you need to, it is very easy to miss variables and column/row names you need to change.

## Steps
<center>
![](images/steps_inter.png){style="width:150px; background: white; border-radius:5px"}
</center>

The steps to carry out this exercise are below along with the solution expandable boxes.

### Inter-media tibble

The first step is to create a tibble containing only observations/rows of intra-media distances from the `beta_long_tbl` tibble.
Call this variable: `inter_media_wunifrac_long_tbl`

__Tip:__ You will need to use the columns `media_L` and `media_R`.

`r hide("Inter-media tibble creation")`
```{r eval=FALSE}
#Subset long tibble so only rows where media_R and media_L are not identical
#I.e. the long tibble only contains paired distances between samples of 
# different media (inter-media distances)
inter_media_wunifrac_long_tbl <-
    beta_long_tbl |>
        dplyr::filter(media_L != media_R)
#Check head of long df
inter_media_wunifrac_long_tbl |> head()
```
`r unhide()`

### Violin plot

With the formatted tibble the next step is to create a violin plot.
Ensure the x axis is separated by the four media groupings (CVP, ENV, KBC, and TSA).
Additionally, colour the points by the paired/right media.

You are aiming for the below plot :

Note: the points are randomly distributed on the x-axis every time you run the command. Therefore yours will most likely look slightly different.

<center>
![](images/wunifrac_inter_media_divergence_violinplot.png){style="width:800px; background: white; border-radius:5px"}
</center>

`r hide("Inter-media violin plot code solution")`
```{r eval=FALSE}
#Inter-media divergence violin plot
inter_media_violin_plot <-
    inter_site_wunifrac_long_tbl |>
    ggplot2::ggplot(aes(x = media_L, y = value)) +
    ggplot2::geom_violin() +
    ggforce::geom_sina(aes(colour = media_R), alpha=0.5) +
    ggplot2::labs(x = "Media", y = "Weighted UniFrac",
                    title="Inter-media divergence with Weighted UniFrac dissimilarity",
                    subtitle="Points coloured by media of paired distance sample",
                    colour = "Media")
#Save ggplot2 object with ggsave
ggsave(filename = "./wunifrac_inter_media_divergence_violinplot.png",
        plot = inter_media_violin_plot,
        device = "png", dpi = 300, units = "mm", height = 100, width = 150)
#Display plot
IRdisplay::display_png(file = "./wunifrac_inter_media_divergence_violinplot.png")
```
`r unhide()`

In the plot we can see:

- The ENV samples are highly dissimilar to the CVP, KBC, and TSA samples (>0.5 Weighted UniFrac) with similar distances between these three pairings.
- The media samples (CVP, KBC, and TSA) are more similar to each other (<05 Weighted UniFrac) compared to the ENV samples.
- CVP and KBC are the two most similar media groupings (i.e. smallest dissimilarity distances).

### Stats

Finally, carry out the pairwise wilcox tests to determine if there are significant difference between the inter-media distances.
Carry this out to compare distances between the four media and to compare the media pairwise distances.

`r hide("Inter-media pairwise wilcox")`
```{r eval=FALSE}
pairwise.wilcox.test(inter_media_wunifrac_long_tbl$value,
                        inter_media_wunifrac_long_tbl$media_L)
```
```{r eval=FALSE}
#Create new tibble for media pair statistics
inter_media_pairs_wunifrac_long_tbl <-
        inter_media_wunifrac_long_tbl |>
                #Retain lower triangle rows
                dplyr::filter(triangle == "lower") |>
                #Convert media_L and media_R to character columns
                #These are originally factors which cannot be ordered alphabetically
                dplyr::mutate(dplyr::across(c(media_L,media_R), as.character)) |>
                #Create new media_L_R column
                #Ensure the first alphabetical media (pmin) is the prefix
                #and the second/last alphabetical media (pmax) is the suffix
                dplyr::mutate(media_L_R = 
                        paste0(pmin(media_L,site_R),"_",pmax(media_L,site_R)))

#Wilcox
pairwise.wilcox.test(inter_media_pairs_wunifrac_long_tbl$value,
                        inter_media_pairs_wunifrac_long_tbl$site_L_R)
```
`r unhide()`

In this case you'lld see there is a significant difference between the intra-group distances of all the different media types except for CVP compared to KBC and CVP compared to TSA.
From the plot we may expect to see no significant difference between the intra-group divergences of KBC and TSA but this is not the case seemingly.

The media pair inter-group divergence stats shows each pairing is significantly different to every other pairing.
Some finer points:

- The three pairings of ENV to the media seem very similar to each other but still have significant p-values values (<0.05) even if CVP_ENV and ENV_KBC barely reach the threshold (0.047).
- The media media pairings have very strong evidence of being different to each other (p-value = < 2e-16).
    - The KBC and CVP samples are the most similar
    - The KBC and TSA samples are the second most similar
    - The CVP and TSA samples are the least dissimilar in terms of the media pairs