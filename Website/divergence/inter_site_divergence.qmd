# Inter-site divergence
<center>
![](images/rivers_inter_site.png){style="width:200px; background: white; border-radius:5px"}
</center>

On this page we'll examine the dissimilarity of samples between the sites, i.e. inter-site divergence.
As a reminder, the sites are different parts of the Durance river:

- Upper Durance (UD)
- Middle Durance (MD)
- Lower Durance (LD)

To analyse the Inter-site divergence we will:

- Subset our long [tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html) of distances and metadata to contain both sets (lower and upper triangle) of inter-group distances.
- Create a violin plot of the inter-site distances
- Carry out a pairwise wilcox test to statistically compare the different inter-site divergences (UD to MD, UD to LD, and MD to LD).

As a reminder we are using [weighted UniFrac distances](https://neof-workshops.github.io/R_community_whqkt8/iterative_rarefaction/19-Beta_distances_metrics.html#unifrac-distances).

## Inter-site tibble
<center>
![](images/site_inter_tibble.png){style="width:150px; background: white; border-radius:5px"}
</center>

```{r eval=FALSE}
#Subset long tibble so only rows where site_R and site_L are not identical
#I.e. the long tibble only contains paired distances between samples of 
# different sites (inter-site distances)
inter_site_wunifrac_long_tbl <-
    beta_long_tbl |>
        dplyr::filter(site_L != site_R)
#Check head of long df
inter_site_wunifrac_long_tbl |> head()
```

## Violin plot
<center>
![](images/violin_plot_inter_site.png){style="width:150px; background: white; border-radius:5px"}
</center>

### Basic plot

```{r eval=FALSE}
#Inter-site divergence violin plot
inter_site_violin_plot <-
    inter_site_wunifrac_long_tbl |>
    ggplot2::ggplot(aes(x = site_L, y = value)) +
    ggplot2::geom_violin() +
    ggforce::geom_sina(alpha=0.5) +
    ggplot2::labs(x = "Site", y = "Weighted UniFrac",
                    title="Inter-site divergence with Weighted UniFrac dissimilarity")
#Save ggplot2 object with ggsave
ggsave(filename = "./wunifrac_inter_site_divergence_violinplot.png",
        plot = inter_site_violin_plot,
        device = "png", dpi = 300, units = "mm", height = 100, width = 150)
#Display plot
IRdisplay::display_png(file = "./wunifrac_inter_site_divergence_violinplot.png")
```

### Points coloured by right site

Let's edit our above violin plot by adding colours to the points.
These will be coloured by the matching paired site grouping (i.e. left media on x axis and right media to colour points).

```{r eval=FALSE}
#Inter-site divergence violin plot
inter_site_violin_plot <-
    inter_site_wunifrac_long_tbl |>
    ggplot2::ggplot(aes(x = site_L, y = value)) +
    ggplot2::geom_violin() +
    ggforce::geom_sina(aes(colour = site_R), alpha=0.5) +
    ggplot2::labs(x = "Site", y = "Weighted UniFrac",
                    title="Inter-site divergence with Weighted UniFrac dissimilarity",
                    subtitle="Points coloured by site of paired distance sample",
                    colour = "Site")
#Save ggplot2 object with ggsave
ggsave(filename = "./wunifrac_inter_site_divergence_violinplot.png",
        plot = inter_site_violin_plot,
        device = "png", dpi = 300, units = "mm", height = 100, width = 150)
#Display plot
IRdisplay::display_png(file = "./wunifrac_inter_site_divergence_violinplot.png")
```

## Stats
<center>
![](images/abacus_intra_site.png){style="width:150px; background: white; border-radius:5px"}
</center>

```{r eval=FALSE}
pairwise.wilcox.test(inter_site_wunifrac_long_tbl$value,
                        inter_site_wunifrac_long_tbl$site_L)
```