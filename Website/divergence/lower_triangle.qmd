# Lower triangle
<center>
![](images/lower_tri.png){style="width:200px; background: white; border-radius:5px"}
</center>

Our first formatting step is to create a long [tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html) of the dissimilarity values in the lower triangle of the dissimilarity matrix.

## Dissimilarity matrix
<center>
![](images/setup_9.png){style="width:150px; background: white; border-radius:5px"}
</center>

Before we start, ensure you have loaded the phyloseq object and dissimilarity matrix as shown in [data and setup page](/divergence/data_and_setup.qmd).

Once it is loaded we can view the top 10 rows and columns of the matrix.

```{r eval = FALSE}
#Check first 10 rows and columns of beta dissimilarity matrix
beta_df_mean[1:10,1:10]
```

## Lower triangle matrix
<center>
![](images/distance_matrix_lower_tri.png){style="width:150px; background: white; border-radius:5px"}
</center>

The next step is to convert the matrix so all but the lower triangle values are `NA`s.

### Demo code

We'll first carry this out with a demonstration.

Create a small version of our distance matrix so it is easy to view.

```{r, eval=FALSE}
#Create demo distance matrix
demo_mat <- beta_df_mean[1:6,1:6]
demo_mat
```

We will use the `upper.tri()` function for our conversion.
It creates a logical matrix from a matrix where the upper triangle values are `TRUE` and the lower triangle values are `FALSE`.

The diagonal values are set with the option `diag=`.
We will set them to `TRUE` with `diag=TRUE`.

```{r eval=FALSE}
#Demonstration of upper.tri
upper.tri(demo_mat, diag=TRUE)
```

We can then subset our matrix with this function to assign the upper triangle and diagonal values as `NA`.

```{r eval=FALSE}
#Convert upper triangle and diaganol to NA
demo_mat[upper.tri(demo_mat, diag=TRUE)] <- NA
demo_mat
```

### Real code

With the above demonstrated we'll create our lower triangle matrix.
For this we will create a new object for the lower triangle matrix so our edits won't change the initial `beta_df_mean` object which we will need later.

```{r eval = FALSE}
#Create new lower triangle matrix
lower_tri_mat <- beta_df_mean
#Convert upper triangle and the diagonal to NAs
lower_tri_mat[upper.tri(lower_tri_mat, diag = TRUE)] <- NA
#Check first 10 rows and columns
lower_tri_mat[1:10,1:10]
```

## Long data frame of lower triangle values
<center>
![](images/long_distance_tibble_lower_triangle.png){style="width:200px; background: white; border-radius:5px"}
</center>


With our lower triangle matrix we can create a long [tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html) for future `ggplot2` plot production.

For this code we utilising [piping (`|>`)](https://neof-workshops.github.io/Tidyverse/dplyr/pipes.html) with the below steps:

- Convert the matrix `lower_tri_mat` to a data frame with `as.data.frame()`
    - Although we will ultimately end up with a [tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html) we need to carry this out for the next steps to run successfully
    - If we converted the matrix to a tibble with [`tibble::as_tibble()`]([tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html)) it would remove the row names which are required for the next command
- Move the row names to a column called "Sample_L" with [`tibble::rownames_to_column`](https://tibble.tidyverse.org/reference/rownames.html)
- Longify all the columns except the "Sample_L" column with [`tidyr::pivot_longer()`](https://neof-workshops.github.io/Tidyverse/tidyr/pivot_longer.html)
    - This also serves to convert our data frame to a [tibble](https://neof-workshops.github.io/Tidyverse/tibble/tibble.html)
- Remove rows with NAs (i.e. the upper triangle and diagonal values) with [`tidyr::drop_na()`](https://neof-workshops.github.io/Tidyverse/tidyr/drop_na.html)
- Create a column called triangle with each value being "lower" with [`dplyr::mutate()`](https://neof-workshops.github.io/Tidyverse/dplyr/mutate.html), this is required later

```{r eval=FALSE}
#Convert to long data frame of paired distance values
#We will refer to the different samples in a pair as the left and right pair
beta_long_tbl <- 
    lower_tri_mat |>
        #Convert to data frame
        as.data.frame() |>
        #Create column from row names (Sample_L, L = left)
        tibble::rownames_to_column("Sample_L") |>
        #Longify
        #Set names to "Sample_R" column (R = right)
        tidyr::pivot_longer(!Sample_L, names_to="Sample_R", values_to="value") |>
        #Remove rows with an NA
        tidyr::drop_na() |>
        #Create triangle column containing value "lower" for each row
        dplyr::mutate(triangle="lower")
#Check head of long tibble
beta_long_tbl |> head()
```

Great! Next we'll add our metadata to this long data frame.